<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - CyberMail Analyzer</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="results-header fade-in">
            <div>
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Analyzer
                </a>
            </div>
            <div class="text-center">
                <h1><i class="fas fa-shield-alt"></i> Analysis Results</h1>
                <p class="text-muted">Email Security Analysis Complete</p>
            </div>
            <div class="text-right">
                <span class="threat-badge {{ 'safe' if result.threat_score <= 30 else 'suspicious' if result.threat_score <= 60 else 'malicious' }}">
                    {{ 'SAFE' if result.threat_score <= 30 else 'SUSPICIOUS' if result.threat_score <= 60 else 'MALICIOUS' }}
                </span>
            </div>
        </header>

        <!-- Threat Score Card -->
        <div class="threat-score-card fade-in">
            <h2><i class="fas fa-exclamation-triangle"></i> Threat Assessment</h2>
            <div class="threat-score {{ 'safe' if result.threat_score <= 30 else 'suspicious' if result.threat_score <= 60 else 'malicious' }}">
                {{ result.threat_score }}
            </div>
            <div class="mb-3">
                <span class="threat-badge {{ 'safe' if result.threat_score <= 30 else 'suspicious' if result.threat_score <= 60 else 'malicious' }}">
                    {{ 'SAFE' if result.threat_score <= 30 else 'SUSPICIOUS' if result.threat_score <= 60 else 'MALICIOUS' }}
                </span>
            </div>
            <div class="text-center">
                <p class="text-muted mb-2">Analysis Mode: <strong>{{ result.mode.upper() }}</strong></p>
                <div class="progress" style="height: 8px; background: var(--bg-darker); border-radius: 4px; overflow: hidden;">
                    <div class="progress-bar" style="
                        width: {{ result.threat_score }}%; 
                        background: {{ 'var(--success-color)' if result.threat_score <= 30 else 'var(--warning-color)' if result.threat_score <= 60 else 'var(--danger-color)' }};
                        transition: width 2s ease-in-out;
                    "></div>
                </div>
            </div>
        </div>

        <!-- Email Headers -->
        <div class="card fade-in slide-in-left">
            <h3><i class="fas fa-envelope"></i> Email Headers</h3>
            <div class="data-table">
                <table>
                    <tr>
                        <th><i class="fas fa-user"></i> From</th>
                        <td>{{ result.headers['From'] or 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th><i class="fas fa-user-check"></i> To</th>
                        <td>{{ result.headers['To'] or 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th><i class="fas fa-tag"></i> Subject</th>
                        <td>{{ result.headers['Subject'] or 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th><i class="fas fa-clock"></i> Date</th>
                        <td>{{ result.headers['Date'] or 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th><i class="fas fa-shield-check"></i> Authentication</th>
                        <td>
                            {% if result.headers['Authentication-Results'] %}
                                <div class="mb-1">
                                    <span class="threat-badge {{ 'safe' if result.auth.spf == 'pass' else 'suspicious' if result.auth.spf in ['softfail','neutral'] else 'malicious' if result.auth.spf == 'fail' else '' }}">SPF: {{ result.auth.spf|upper }}</span>
                                    <span class="threat-badge {{ 'safe' if result.auth.dkim == 'pass' else 'malicious' if result.auth.dkim == 'fail' else 'suspicious' if result.auth.dkim in ['softfail','neutral'] else '' }}">DKIM: {{ result.auth.dkim|upper }}</span>
                                    <span class="threat-badge {{ 'safe' if result.auth.dmarc == 'pass' else 'malicious' if result.auth.dmarc == 'fail' else 'suspicious' if result.auth.dmarc in ['softfail','neutral'] else '' }}">DMARC: {{ result.auth.dmarc|upper }}</span>
                                </div>
                                <pre style="white-space: pre-wrap; font-size: 0.8rem; background: var(--bg-darker); padding: 1rem; border-radius: 4px; margin: 0;">{{ result.headers['Authentication-Results'] }}</pre>
                            {% else %}
                                <span class="text-muted">No authentication data</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
            {% if result.threat_score > 60 and result.header_issues and result.header_issues|length > 0 %}
            <div class="mt-2">
                <strong>Header issues:</strong>
                {% for issue in result.header_issues %}
                    <span class="threat-badge malicious">{{ issue }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- IP Analysis -->
        {% if result.ip_geos %}
        <div class="card fade-in slide-in-right">
            <h3><i class="fas fa-map-marker-alt"></i> IP Hops & Geolocation</h3>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th><i class="fas fa-server"></i> IP Address</th>
                            <th><i class="fas fa-globe"></i> Location</th>
                            <th><i class="fas fa-building"></i> ISP</th>
                            <th><i class="fas fa-shield-alt"></i> Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for hop in result.ip_geos %}
                        <tr>
                            <td><strong>{{ loop.index }}</strong></td>
                            <td>
                                <code style="background: var(--bg-darker); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ hop.ip }}</code>
                            </td>
                            <td>
                                {% if hop.geo.status == 'success' %}
                                    <span class="status-indicator success"></span>
                                    {{ hop.geo.city }}, {{ hop.geo.country }}
                                {% elif hop.geo.status == 'offline' %}
                                    <span class="status-indicator muted"></span>
                                    <span class="text-muted">Offline mode</span>
                                {% else %}
                                    <span class="status-indicator danger"></span>
                                    <span class="text-muted">Lookup failed</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if hop.geo.status == 'success' %}
                                    {{ hop.geo.isp or 'Unknown' }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if hop.geo.status == 'success' %}
                                    <span class="threat-badge safe">OK</span>
                                {% else %}
                                    <span class="threat-badge suspicious">UNKNOWN</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Link Analysis -->
        {% if result.links %}
        <div class="card fade-in slide-in-left">
            <h3><i class="fas fa-link"></i> Link Analysis</h3>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th><i class="fas fa-external-link-alt"></i> Original URL</th>
                            <th><i class="fas fa-expand-arrows-alt"></i> Final URL</th>
                            <th><i class="fas fa-compress"></i> Shortened</th>
                            <th><i class="fas fa-shield-virus"></i> Status</th>
                            <th><i class="fas fa-info-circle"></i> Domain Intel</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for l in result.links %}
                        <tr>
                            <td><strong>{{ loop.index }}</strong></td>
                            <td style="max-width: 300px;">
                                <a href="{{ l.original }}" target="_blank" 
                                   style="color: var(--primary-color); text-decoration: none; word-wrap: break-word; word-break: break-all; display: block;"
                                   title="{{ l.original }}">
                                    {{ l.original }}
                                </a>
                            </td>
                            <td style="max-width: 300px;">
                                <a href="{{ l.final }}" target="_blank" 
                                   style="color: var(--secondary-color); text-decoration: none; word-wrap: break-word; word-break: break-all; display: block;"
                                   title="{{ l.final }}">
                                    {{ l.final }}
                                </a>
                            </td>
                            <td style="max-width: 100px; text-align: center;">
                                {% if l.shortened %}
                                    <span class="threat-badge suspicious">YES</span>
                                {% else %}
                                    <span class="threat-badge safe">NO</span>
                                {% endif %}
                            </td>
                            <td style="max-width: 120px;">
                                <span class="status-indicator {{ 'warning' if l.shortened else 'success' }}"></span>
                                {{ 'Suspicious' if l.shortened else 'Normal' }}
                            </td>
                            <td style="max-width: 400px; min-width: 200px;">
                                {% set intel = result.link_intel[loop.index0] %}
                                {% if intel and intel.domain %}
                                    <div class="mb-1" style="word-wrap: break-word; word-break: break-all;"><strong>{{ intel.domain }}</strong></div>
                                    {% if intel.whois %}
                                        <div class="mb-1" style="word-wrap: break-word; word-break: break-all;"><small>Registrar: {{ intel.whois.registrar or 'Unknown' }}</small></div>
                                        <div class="mb-1"><small>Age: {{ intel.whois.age_days if intel.whois.age_days is not none else 'N/A' }} days</small></div>
                                    {% endif %}
                                    {% if intel.dns %}
                                        <div class="mb-1" style="word-wrap: break-word; word-break: break-all;">
                                            <small>MX: 
                                                {% if intel.dns.mx and intel.dns.mx|length > 0 %}
                                                    {{ intel.dns.mx | join(', ') }}
                                                {% else %}
                                                    None
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="mb-1" style="word-wrap: break-word; word-break: break-all;">
                                            <small>SOA: 
                                                {% if intel.dns.soa and intel.dns.soa|length > 0 %}
                                                    {{ intel.dns.soa | join(', ') }}
                                                {% else %}
                                                    None
                                                {% endif %}
                                            </small>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Attachments -->
        {% if result.attachments %}
        <div class="card fade-in slide-in-right">
            <h3><i class="fas fa-paperclip"></i> Attachments</h3>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th><i class="fas fa-file"></i> Filename</th>
                            <th><i class="fas fa-tag"></i> Type</th>
                            <th><i class="fas fa-weight-hanging"></i> Size</th>
                            <th><i class="fas fa-shield-alt"></i> Risk</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in result.attachments %}
                        <tr>
                            <td><strong>{{ loop.index }}</strong></td>
                            <td>
                                <code style="background: var(--bg-darker); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ a.filename }}</code>
                            </td>
                            <td>{{ a.content_type or 'Unknown' }}</td>
                            <td>{{ "{:,}".format(a.size) }} bytes</td>
                            <td>
                                {% if a.risky %}
                                    <span class="threat-badge suspicious">RISK</span>
                                {% else %}
                                    <span class="threat-badge safe">SAFE</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Attachment MalwareBazaar Check Results -->
        {% if result.attachment_checks is defined and result.attachment_checks|length > 0 %}
        <div class="card fade-in slide-in-right">
            <h3><i class="fas fa-bug"></i> Attachment MalwareBazaar Check</h3>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Filename</th>
                            <th>Status</th>
                            <th>SHA-256</th>
                            <th>Malware Info</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ac in result.attachment_checks %}
                        <tr>
                            <td><strong>{{ loop.index }}</strong></td>
                            <td>{{ ac.filename }}</td>
                            <td>
                                {% if ac.status == 'malware' %}
                                    <span class="threat-badge malicious">MALWARE</span>
                                {% elif ac.status == 'safe' %}
                                    <span class="threat-badge safe">SAFE</span>
                                {% else %}
                                    <span class="threat-badge suspicious">ERROR</span>
                                {% endif %}
                            </td>
                            <td><code style="background: var(--bg-darker); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ ac.sha256 }}</code></td>
                            <td>
                                {% if ac.status == 'malware' and ac.info %}
                                    <pre style="white-space: pre-wrap; font-size: 0.8rem; background: var(--bg-darker); padding: 1rem; border-radius: 4px; margin: 0;">{{ ac.info }}</pre>
                                {% elif ac.status == 'safe' %}
                                    <span class="text-muted">No match in MalwareBazaar</span>
                                {% else %}
                                    <span class="text-muted">{{ ac.info }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- VirusTotal URL Results -->
        {% if result.vt_results and result.vt_results|length > 0 %}
        <div class="card fade-in slide-in-left">
            <h3><i class="fas fa-shield-virus"></i> VirusTotal URL Checks</h3>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>URL</th>
                            <th>Summary</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in result.vt_results %}
                        <tr>
                            <td><strong>{{ loop.index }}</strong></td>
                            <td>
                                <a href="{{ v.url }}" target="_blank" style="color: var(--secondary-color); text-decoration: none;">
                                    {{ v.url[:60] }}{{ '...' if v.url|length > 60 else '' }}
                                </a>
                            </td>
                            <td>
                                <pre style="white-space: pre-wrap; font-size: 0.8rem; background: var(--bg-darker); padding: 1rem; border-radius: 4px; margin: 0;">{{ v.vt }}</pre>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- OSINT Results -->
        {% if result.blacklist_hits %}
        <div class="card fade-in slide-in-left">
            <h3><i class="fas fa-exclamation-triangle"></i> Security Alerts</h3>
            <div style="background: var(--bg-darker); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--danger-color);">
                {% for hit in result.blacklist_hits %}
                <div class="mb-2">
                    <span class="status-indicator danger"></span>
                    <strong>Blacklist Alert:</strong> {{ hit }}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Threat Breakdown -->
        <div class="card fade-in slide-in-right">
            <h3><i class="fas fa-chart-pie"></i> Threat Analysis Breakdown</h3>
            <div style="background: var(--bg-darker); padding: 1.5rem; border-radius: 8px;">
                <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem; margin: 0; color: var(--text-secondary);">{{ result.breakdown }}</pre>
            </div>
            <div class="mt-2">
                <canvas id="heuristicsChart" height="120"></canvas>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mb-4 fade-in">
            <a href="/" class="btn btn-primary">
                <i class="fas fa-plus"></i> Analyze Another Email
            </a>
            <button onclick="window.print()" class="btn btn-secondary">
                <i class="fas fa-print"></i> Print Report
            </button>
            <button id="downloadJson" class="btn btn-secondary">
                <i class="fas fa-file-download"></i> Download JSON
            </button>
        </div>
    </div>

    <script>
        // Add animations on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Observe all cards for scroll animations (do not hide by default)
        document.querySelectorAll('.card').forEach(card => {
            try { observer.observe(card); } catch (e) {}
        });

        // Add hover effects to interactive elements
        document.querySelectorAll('a[href^="http"]').forEach(link => {
            link.addEventListener('mouseenter', () => {
                link.style.transform = 'scale(1.05)';
                link.style.transition = 'transform 0.2s ease';
            });
            
            link.addEventListener('mouseleave', () => {
                link.style.transform = 'scale(1)';
            });
        });

        // Add click effects to buttons
        document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
            });
        });

        // Progress bar animation
        window.addEventListener('load', () => {
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
                setTimeout(() => {
                    progressBar.style.width = '{{ result.threat_score }}%';
                }, 500);
            }
            // Download JSON button
            const btn = document.getElementById('downloadJson');
            if (btn) {
                btn.addEventListener('click', () => {
                    const data = {{ result | tojson | safe }};
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'analysis-result.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            }

            // Heuristics chart
            try {
                const ctx = document.getElementById('heuristicsChart');
                if (ctx && window.Chart) {
                    const breakdown = {{ result.breakdown | tojson | safe }};
                    const counts = {
                        auth: (breakdown.spf === 'fail' ? 1 : 0) + (breakdown.dkim === 'fail' ? 1 : 0) + (breakdown.dmarc === 'fail' ? 1 : 0),
                        blacklists: (breakdown.blacklist_hits ? breakdown.blacklist_hits.length : 0),
                        attachments: (breakdown.risky_attachments ? breakdown.risky_attachments.length : 0),
                        links: (breakdown.risky_links || 0)
                    };
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Auth', 'Blacklists', 'Attachments', 'Links'],
                            datasets: [{
                                label: 'Risk components',
                                data: [counts.auth, counts.blacklists, counts.attachments, counts.links],
                                backgroundColor: ['#ff4444', '#ffaa00', '#ffaa00', '#ff4444']
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { display: false } } }
                    });
                }
            } catch (e) {}
        });
    </script>
</body>
</html>